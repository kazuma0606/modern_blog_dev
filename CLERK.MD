# Clerk èªè¨¼ã¨ `User` ãƒ†ãƒ¼ãƒ–ãƒ«ã®é€£æº

## **ğŸ“Œ 1ï¸âƒ£ `User` ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å¿…è¦ï¼Ÿ**
âœ… **å¿…è¦ï¼**
- Clerk ã¯èªè¨¼ï¼ˆAuthï¼‰ã‚’ç®¡ç†ã™ã‚‹ãŒã€ã‚¢ãƒ—ãƒªå†…ã§ `User` ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã« **`User` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå¿…é ˆ**ã€‚
- `Favorite` / `Bookmark` / `Comment` / `Notification` ãªã©ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç´ã¥ããƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã€**DB å†…ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå¿…è¦**ã€‚

## **ğŸ“Œ 2ï¸âƒ£ Clerk èªè¨¼ã¨ã®é€£æºãƒ•ãƒ­ãƒ¼**

1ï¸âƒ£ **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ Clerk ã«ãƒ­ã‚°ã‚¤ãƒ³** â†’ Clerk ã® `userId` ã‚’å–å¾—
2ï¸âƒ£ **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆNestJSï¼‰ã« `userId` ã‚’é€ä¿¡**
3ï¸âƒ£ **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ `User` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèª**
   - `userId` ãŒ **å­˜åœ¨ã—ãªã„å ´åˆ** â†’ `User` ã‚’ **æ–°è¦ä½œæˆ**
   - `userId` ãŒ **æ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆ** â†’ ä½•ã‚‚ã—ãªã„


## **ğŸ“Œ 3ï¸âƒ£ `User` ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¨­è¨ˆ**

```prisma
model User {
  id          String   @id @unique // Clerk ã® userId ã‚’æ ¼ç´
  name        String?  @db.VarChar(255)
  mail_address String  @unique @db.VarChar(255)
  role        Role     @default(USER)
  createdAt   DateTime @default(now()) @db.Timestamp(0)
  updatedAt   DateTime @updatedAt @db.Timestamp(0)
  
  Favorite    Favorite[]
  Bookmark    Bookmark[]
}

enum Role {
  ADMIN
  USER
}
```

## **ğŸ“Œ 4ï¸âƒ£ åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã« `User` ã‚’ä½œæˆ**

ğŸ”¹ **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (NestJS) ã® `auth.service.ts`**

```ts
import { Injectable } from '@nestjs/common';
import { PrismaService } from '../prisma.service';
import Clerk from '@clerk/clerk-sdk-node';

@Injectable()
export class AuthService {
  constructor(private prisma: PrismaService) {}

  async syncUserWithClerk(userId: string) {
    // Clerk ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    const clerkUser = await Clerk.users.getUser(userId);

    // DB ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    let user = await this.prisma.user.findUnique({
      where: { id: userId },
    });

    // å­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
    if (!user) {
      user = await this.prisma.user.create({
        data: {
          id: clerkUser.id,
          name: clerkUser.firstName ?? '',
          mail_address: clerkUser.emailAddresses[0]?.emailAddress ?? '',
        },
      });
    }

    return user;
  }
}
```

## **ğŸ“Œ 5ï¸âƒ£ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ `Clerk` ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—**

ğŸ”¹ **Next.js (`auth.ts`)**

```ts
import { useUser } from "@clerk/nextjs";
import axios from "axios";

export const useSyncUser = async () => {
  const { user } = useUser();

  if (user) {
    await axios.post("/api/auth/sync", { userId: user.id });
  }
};
```

## **ğŸ“Œ 6ï¸âƒ£ ã¾ã¨ã‚**
âœ… **Clerk ã® `userId` ã‚’ `User` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `id` ã«ä¿å­˜**
âœ… **åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã« `User` ã‚’DBã«åŒæœŸ**
âœ… **ä»¥é™ã€DBã® `User` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ `userId` ã§å‚ç…§å¯èƒ½**
âœ… **ã‚¢ãƒ—ãƒªã® `Favorite` / `Bookmark` / `Comment` ã¯ `User` ã® `id` ã‚’åŸºã«ç®¡ç†**

ğŸ‘‰ **Clerk ã®èªè¨¼æ©Ÿèƒ½ã¨ Prisma ã®DBç®¡ç†ã‚’çµ±åˆã—ã€ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªèªè¨¼é€£æºã‚’å®Ÿç¾ï¼ğŸš€ğŸ”¥**

